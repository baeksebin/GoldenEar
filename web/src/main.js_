/**
 * [Config] ìƒìˆ˜ ì„¤ì •
 * ì‹œìŠ¤í…œì—ì„œ ë³€ê²½ë˜ì§€ ì•ŠëŠ” ì„¤ì •ê°’ë“¤ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.
 */
const SAMPLES_CONFIG = {
    "C3": "C3.mp3", "Cs3": "Db3.mp3", "D3": "D3.mp3", "Ds3": "Eb3.mp3", "E3": "E3.mp3",
    "F3": "F3.mp3", "Fs3": "Gb3.mp3", "G3": "G3.mp3", "Gs3": "Ab3.mp3", "A3": "A3.mp3", "As3": "Bb3.mp3", "B3": "B3.mp3",
    "C4": "C4.mp3", "Cs4": "Db4.mp3", "D4": "D4.mp3", "Ds4": "Eb4.mp3", "E4": "E4.mp3",
    "F4": "F4.mp3", "Fs4": "Gb4.mp3", "G4": "G4.mp3", "Gs4": "Ab4.mp3", "A4": "A4.mp3", "As4": "Bb4.mp3", "B4": "B4.mp3",
    "C5": "C5.mp3", "Cs5": "Db5.mp3", "D5": "D5.mp3", "Ds5": "Eb5.mp3", "E5": "E5.mp3",
    "F5": "F5.mp3", "Fs5": "Gb5.mp3", "G5": "G5.mp3", "Gs5": "Ab5.mp3", "A5": "A5.mp3", "As5": "Bb5.mp3", "B5": "B5.mp3"
};

const NOTE_NAMES = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
const OCTAVES = [3, 4, 5];

/**
 * [State] ì „ì—­ ìƒíƒœ ê´€ë¦¬
 */
let VF = null;
let audioCtx = null;
const audioBuffers = {};
let isAudioLoaded = false;
let currentCorrectNote = ""; 
let isAnswered = false;      
let currentLevel = "1";      

// DOM ìºì‹± (ì„±ëŠ¥ í–¥ìƒì„ ìœ„í•´ ì „ì—­ ì°¸ì¡°)
const el = {
    homeScreen: null, trainingScreen: null,
    instruction: null, actionButtons: null,
    output: null, levelSelect: null,
    pianoContainer: null, pianoWrapper: null,
    navContainer: null, navIndicator: null, navWrapper: null
};

/**
 * [Layer 1] ì´ˆê¸°í™” ë° ì—”ì§„ ë¡œë“œ
 */

// ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—°ê²° ë° DOM ìš”ì†Œ ìºì‹±
function initialize() {
    if (window.Vex && window.Vex.Flow) VF = window.Vex.Flow;
    
    el.homeScreen = document.getElementById('home-screen');
    el.trainingScreen = document.getElementById('training-screen');
    el.instruction = document.getElementById("quiz-instruction");
    el.actionButtons = document.getElementById("action-buttons");
    el.output = document.getElementById("output");
    el.levelSelect = document.getElementById("level-select");
    el.pianoContainer = document.getElementById("piano-container");
    el.pianoWrapper = document.getElementById("piano-wrapper");
    el.navContainer = document.getElementById('piano-navigator-container');
    el.navIndicator = document.getElementById('navigator-indicator');
    el.navWrapper = document.getElementById('piano-navigator-wrapper');

    initStaticEventListeners();
}

// ì˜¤ë””ì˜¤ ìƒ˜í”Œ í”„ë¦¬ë¡œë“œ (DAO íŒ¨í„´ì²˜ëŸ¼ ë°ì´í„° ë¡œë“œ ì „ë‹´)
async function loadSamples() {
    const entries = Object.entries(SAMPLES_CONFIG);
    await Promise.all(entries.map(([name, file]) => {
        return new Promise((resolve) => {
            const audio = new Audio(`./samples/${file}`);
            audio.preload = "auto";
            audio.oncanplaythrough = () => { audioBuffers[name] = { audio }; resolve(); };
            audio.onerror = () => resolve(); // ì—ëŸ¬ ì‹œì—ë„ ì§„í–‰
        });
    }));
    isAudioLoaded = true;
    console.log("ğŸ¹ Audio Samples Cached");
}

/**
 * [Layer 2] ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (Service)
 */

// ì‚¬ìš´ë“œ ì¬ìƒ ì²˜ë¦¬
function playNote(fullNote) {
    if (!isAudioLoaded) return;
    const [name, oct] = fullNote.split("/");
    const key = name.replace("#", "s") + oct;
    const sample = audioBuffers[key];
    if (sample) {
        sample.audio.currentTime = 0;
        sample.audio.play().catch(() => {});
    }
}

// ë¬¸ì œ ìŒì› ì¬ìƒ
function playQuestion() {
    if (currentCorrectNote) playNote(currentCorrectNote);
}

// ëœë¤ ë¬¸ì œ ìƒì„± (Factory)
function getRandomNote() {
    let pool = (currentLevel === "1") ? ["C", "D", "E", "F", "G", "A", "B"] : NOTE_NAMES;
    const name = pool[Math.floor(Math.random() * pool.length)];
    const oct = (currentLevel === "3") ? OCTAVES[Math.floor(Math.random() * 3)] : 4;
    return `${name}/${oct}`;
}

// í€´ì¦ˆ ìƒì„± ë° ì´ˆê¸°í™” (Controller)
function generateQuiz(preventAutoPlay = false) {
    if (!isAudioLoaded) return;
    currentCorrectNote = getRandomNote();
    isAnswered = false;
    
    el.instruction.innerHTML = "ì–´ë–¤ ì†Œë¦¬ì¼ê¹Œìš”? <br><small>(ì•…ë³´ í´ë¦­ ì‹œ ë‹¤ì‹œ ë“£ê¸°)</small>";
    renderActionButtons(false); // ì´ˆê¸° ìƒíƒœ ë²„íŠ¼ ë Œë”ë§
    
    drawStave("");
    renderPianoKeyboard();
    if (!preventAutoPlay) setTimeout(playQuestion, 600);
}

/**
 * [Layer 3] UI ë Œë”ë§ (View)
 */

// ì•…ë³´ ê·¸ë¦¬ê¸° (VexFlow í™œìš©)
function drawStave(userNote = "", isCorrect = null) {
    if (!VF || !el.output) return;
    el.output.innerHTML = "";
    
    const w = el.output.offsetWidth || 320;
    const renderer = new VF.Renderer(el.output, VF.Renderer.Backends.SVG);
    renderer.resize(w, 200);
    const context = renderer.getContext();
    const stave = new VF.Stave((w - 260) / 2, 40, 260).addClef("treble");
    stave.setContext(context).draw();

    if (userNote && currentCorrectNote) {
        try {
            const format = (n) => n.toLowerCase();
            let notes = [];
            const color = isCorrect ? "#28a745" : "#dc3545";
            
            const n = new VF.StaveNote({ keys: [format(userNote)], duration: "h" });
            n.setStyle({ fillStyle: color, strokeStyle: color });
            if (userNote.includes("#")) n.addModifier(new VF.Accidental("#"), 0);
            
            notes = isCorrect ? [
                new VF.StaveNote({ keys: [format(currentCorrectNote)], duration: "h" }), n
            ] : [n];

            if (isCorrect && currentCorrectNote.includes("#")) notes[0].addModifier(new VF.Accidental("#"), 0);

            const voice = new VF.Voice({ num_beats: notes.length * 2, beat_value: 4 }).addTickables(notes);
            new VF.Formatter().joinVoices([voice]).format([voice], notes.length * 80);
            voice.draw(context, stave);
        } catch (e) { console.error(e); }
    }
}

// í”¼ì•„ë…¸ ê±´ë°˜ ë° í•˜ë‹¨ ë„¤ë¹„ê²Œì´í„° ë™ì‹œ ìƒì„±
function renderPianoKeyboard() {
    // DOM ì°¸ì¡° í™•ì¸ (el ê°ì²´ ì‚¬ìš©)
    const container = el.pianoContainer;
    const navContainer = el.navContainer;
    const indicator = el.navIndicator;
    const wrapper = el.pianoWrapper;
    const navWrapper = el.navWrapper;

    if (!container || !navContainer) return;

    // ê¸°ì¡´ ë‚´ìš© ì‚­ì œ (ì¤‘ë³µ ìƒì„± ë°©ì§€)
    container.innerHTML = ""; 
    navContainer.innerHTML = "";

    const octaves = [3, 4, 5];
    const notes = [
        { n: "C", t: "white" }, { n: "C#", t: "black" }, { n: "D", t: "white" }, { n: "D#", t: "black" },
        { n: "E", t: "white" }, { n: "F", t: "white" }, { n: "F#", t: "black" }, { n: "G", t: "white" },
        { n: "G#", t: "black" }, { n: "A", t: "white" }, { n: "A#", t: "black" }, { n: "B", t: "white" }
    ];

    const mainFragment = document.createDocumentFragment();
    const navFragment = document.createDocumentFragment();

    octaves.forEach(oct => {
        notes.forEach(note => {
            const full = `${note.n}/${oct}`;

            // 1. ìƒë‹¨ í° ê±´ë°˜ ìƒì„±
            const key = document.createElement("div");
            key.className = note.t === "white" ? "white-key" : "black-key";
            
            key.addEventListener("pointerdown", e => {
                e.preventDefault();
                playNote(full); // playNoteNative ëŒ€ì‹  í†µí•©ëœ playNote ì‚¬ìš©
                key.classList.add("active");

                if (!isAnswered && currentCorrectNote) {
                    isAnswered = true;
                    const isCorrect = (full === currentCorrectNote);
                    drawStave(full, isCorrect);
                    updateQuizResultUI(isCorrect);
                }
            });
            key.addEventListener("pointerup", () => key.classList.remove("active"));
            key.addEventListener("pointerleave", () => key.classList.remove("active"));
            mainFragment.appendChild(key);

            // 2. í•˜ë‹¨ ë„¤ë¹„ê²Œì´í„° ë¯¸ë‹ˆ ê±´ë°˜ ìƒì„±
            const miniKey = document.createElement("div");
            miniKey.className = note.t === "white" ? "nav-white" : "nav-black";
            navFragment.appendChild(miniKey);
        });
    });

    container.appendChild(mainFragment);
    navContainer.appendChild(navFragment);

    // ìŠ¬ë¼ì´ë” ì´ˆê¸°í™” (ì´ë²¤íŠ¸ ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•´ ì´ˆê¸°í™” ì‹œ 1íšŒë§Œ ì„¤ì •í•˜ê±°ë‚˜ í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ ì²˜ë¦¬)
    setupSlider(container, navContainer, indicator, wrapper, navWrapper);
}

// ìŠ¬ë¼ì´ë” í•¸ë“¤ëŸ¬ (ì´ë™ ë¡œì§ í†µí•©)
function setupSlider(container, navContainer, indicator, wrapper, navWrapper) {
    let isDragging = false;

    const moveIndicator = (clientX) => {
        const navRect = navContainer.getBoundingClientRect();
        const navWidth = navRect.width;
        
        // indicatorì˜ ë„ˆë¹„ë„ ì •ë°€í•˜ê²Œ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const indicatorRect = indicator.getBoundingClientRect();
        const indicatorWidth = indicatorRect.width;
        
        const maxLeft = navWidth - indicatorWidth;
        
        let x = clientX - navRect.left;
        let leftPos = x - (indicatorWidth / 2);
        
        // âœ… [ê°•ë ¥ ë³´ì •] ìì„ íš¨ê³¼ ë²”ìœ„ë¥¼ 3pxë¡œ ì‚´ì§ ëŠ˜ë ¤ í™•ì‹¤íˆ ë°€ì°©ì‹œí‚µë‹ˆë‹¤.
        if (leftPos < 3) leftPos = 0;
        if (leftPos > maxLeft - 3) leftPos = maxLeft;
        
        leftPos = Math.max(0, Math.min(leftPos, maxLeft));
        
        // í¼ì„¼íŠ¸ ë‹¨ìœ„ ìœ ì§€ (ì†Œìˆ˜ì  ì˜¤ì°¨ ë°©ì§€)
        const leftPercent = (leftPos / navWidth) * 100;
        indicator.style.left = leftPercent + "%";
        
        // ì‹¤ì œ ìŠ¤í¬ë¡¤ ì´ë™ ì—°ë™
        const scrollRatio = maxLeft > 0 ? leftPos / maxLeft : 0;
        
        // container.scrollWidth ê³„ì‚° ì‹œ ì˜¤ì°¨ë¥¼ ì¤„ì´ê¸° ìœ„í•´ Math.ceil ì‚¬ìš© ê³ ë ¤
        const maxScroll = container.scrollWidth - wrapper.clientWidth;
        wrapper.scrollLeft = scrollRatio * maxScroll;
    };
    navWrapper.onpointerdown = (e) => {
        isDragging = true;
        navWrapper.setPointerCapture(e.pointerId);
        moveIndicator(e.clientX);
    };

    window.onpointermove = (e) => {
        if (isDragging) moveIndicator(e.clientX);
    };

    window.onpointerup = (e) => {
        if (isDragging) {
            navWrapper.releasePointerCapture(e.pointerId);
            isDragging = false;
        }
    };
}

/**
 * [Layer 4] Event & Controller
 */

// ì •ë‹µ/ì˜¤ë‹µ ê²°ê³¼ì— ë”°ë¥¸ UI ì—…ë°ì´íŠ¸
function updateQuizResultUI(isCorrect) {
    el.instruction.innerHTML = isCorrect ? 
        "<span style='color:#28a745;font-weight:bold'>ì •ë‹µ ğŸ‰</span>" : 
        "<span style='color:#dc3545;font-weight:bold'>ì˜¤ë‹µ âŒ</span>";
    
    // ë¬¸ì œë¥¼ í’€ì—ˆìœ¼ë¯€ë¡œ(isFinished = true) ê²°ê³¼ ë²„íŠ¼ë“¤ì„ ë Œë”ë§í•©ë‹ˆë‹¤.
    renderActionButtons(true);
}

// ë²„íŠ¼ ì˜ì—­ ë™ì  ìƒì„± (ì´ë²¤íŠ¸ ì§ì ‘ ë°”ì¸ë”©)
/**
 * @param {boolean} isFinished - ë¬¸ì œë¥¼ í’€ì—ˆëŠ”ì§€(ì •ë‹µ/ì˜¤ë‹µ í´ë¦­ í›„) ì—¬ë¶€
 */
function renderActionButtons(isFinished = false) {
    el.actionButtons.innerHTML = "";
    
    if (!isFinished) {
        // 1. ë¬¸ì œë¥¼ í’€ê¸° ì „: ì˜¤ì§ [ë¬¸ì œ ë‹¤ì‹œ ë“£ê¸°] ë²„íŠ¼ë§Œ ë…¸ì¶œ
        const btnReplay = createBtn("ë¬¸ì œ ë‹¤ì‹œ ë“£ê¸°", "main-btn", playQuestion);
        el.actionButtons.appendChild(btnReplay);
    } else {
        // 2. ì •ë‹µ í˜¹ì€ ì˜¤ë‹µì„ í´ë¦­í•œ í›„: [ë‹¤ì‹œ í’€ê¸°]ì™€ [ë‹¤ìŒ ë¬¸ì œ] ë…¸ì¶œ
        // 'ë‹¤ì‹œ í’€ê¸°'ëŠ” í˜„ì¬ ë¬¸ì œì˜ ìƒíƒœë¥¼ ë¦¬ì…‹í•˜ê³  ì†Œë¦¬ë¥¼ ë‹¤ì‹œ ë“¤ë ¤ì¤ë‹ˆë‹¤.
        const btnRetry = createBtn("ë‹¤ì‹œ í’€ê¸°", "main-btn", () => {
            isAnswered = false; 
            drawStave(""); // ì•…ë³´ ì´ˆê¸°í™”
            playQuestion(); // ì†Œë¦¬ ë‹¤ì‹œ ì¬ìƒ
            renderActionButtons(false); // ë²„íŠ¼ì„ ë‹¤ì‹œ 'ë‹¤ì‹œ ë“£ê¸°' ìƒíƒœë¡œ ë³€ê²½
            el.instruction.innerHTML = "ì–´ë–¤ ì†Œë¦¬ì¼ê¹Œìš”? <br><small>(ì•…ë³´ í´ë¦­ ì‹œ ë‹¤ì‹œ ë“£ê¸°)</small>";
        }, "#6c757d"); // ë‹¤ì‹œ í’€ê¸°ëŠ” ë³´ì¡° ë²„íŠ¼ ìƒ‰ìƒ

        const btnNext = createBtn("ë‹¤ìŒ ë¬¸ì œ", "main-btn", () => {
            generateQuiz(); // ìƒˆ ë¬¸ì œ ìƒì„±
        });

        el.actionButtons.appendChild(btnRetry);
        el.actionButtons.appendChild(btnNext);
    }
}

// í—¬í¼: ë²„íŠ¼ ìƒì„± ë° ì´ë²¤íŠ¸ ë°”ì¸ë”©
function createBtn(text, cls, clickFn, bg = "") {
    const b = document.createElement("button");
    b.className = cls; b.innerText = text;
    if (bg) b.style.backgroundColor = bg;
    b.onclick = clickFn;
    return b;
}

// ì •ì  ìš”ì†Œ ì´ë²¤íŠ¸ ë°”ì¸ë”© (HTML onclick ëŒ€ì²´)
function initStaticEventListeners() {
    document.querySelector('.menu-card')?.addEventListener('click', () => {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        el.homeScreen.style.display = 'none';
        el.trainingScreen.style.display = 'flex';
        generateQuiz(false);
    });

    document.querySelector('.back-btn')?.addEventListener('click', () => {
        el.homeScreen.style.display = 'flex';
        el.trainingScreen.style.display = 'none';
    });

    el.levelSelect?.addEventListener('change', (e) => {
        currentLevel = e.target.value;
        generateQuiz(false);
    });
    
    el.output.onclick = playQuestion;
}

/**
 * [EntryPoint]
 */
window.onload = async () => {
    initialize();
    await loadSamples(); 
};